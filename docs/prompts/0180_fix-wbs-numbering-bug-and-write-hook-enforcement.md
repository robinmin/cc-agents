---
name: fix-wbs-numbering-bug-and-write-hook-enforcement
description: "Phase 1a: Fix critical WBS numbering bug and add PreToolUse hook to prevent manual task file creation"
status: Done
created_at: 2026-02-09 16:13:36
updated_at: 2026-02-09 16:25:57
impl_progress:
  planning: completed
  design: pending
  implementation: pending
  review: pending
  testing: pending
dependencies: []
tags: [tasks-enhancement, critical-bug, infrastructure]
---

## 0180. fix-wbs-numbering-bug-and-write-hook-enforcement

### Background

Both `rd2:super-brain` and `rd2:super-architect` independently identified a critical WBS numbering bug in `tasks.py` during analysis of the tasks skill enhancement. The bug at line ~679 uses `len(existing_tasks) + 1` to compute next WBS number, which causes collisions when tasks are deleted (gaps in numbering). This was confirmed in practice: creating 5 new tasks produced WBS 0175-0179, but 0175-0177 already existed, creating duplicate WBS numbers.

Additionally, agents frequently bypass the `tasks create` CLI by directly using the Write tool to create files in `docs/prompts/`. This produces task files without proper templates, frontmatter, or kanban sync.

### Requirements

**Functional Requirements:**

1. **Fix WBS numbering bug** in `tasks.py`:
   - Replace `len(existing_tasks) + 1` with `max(existing_WBS_numbers) + 1`
   - Scan all files matching `docs/prompts/[0-9][0-9][0-9][0-9]_*.md` pattern
   - Extract WBS numbers, find max, add 1
   - Handle edge case: empty directory (start at 0001)

2. **Add PreToolUse hook** to block manual Write to `docs/prompts/`:
   - Create or update hook in `.claude/hooks/` that intercepts Write tool calls
   - If target path matches `docs/prompts/[0-9]{4}_*.md`, block with message: "Use `tasks create` CLI instead of writing task files directly"
   - Allow writes to non-task files in `docs/prompts/` (e.g., `.kanban.md`, `.template.md`)
   - Allow writes to task subdirectories (e.g., `docs/prompts/0089/`)

**Acceptance Criteria:**
- [ ] `tasks create` always produces unique, monotonically increasing WBS numbers
- [ ] Creating a task after deleting tasks does not reuse WBS numbers
- [ ] Direct Write to `docs/prompts/0XXX_*.md` is blocked by hook with clear error message
- [ ] Writes to `.kanban.md`, `.template.md`, and subdirectories still work
- [ ] All existing tests pass
- [ ] New unit tests for WBS numbering edge cases

### Q&A

**Q:** Should the hook also block Edit tool on task file frontmatter?
**A:** Not in this phase. Phase 1b handles validation. The hook should only block *creation* of new task files via Write.

**Q:** What about the 3 duplicate WBS files (0175, 0176, 0177) already created?
**A:** Already manually resolved by renaming to 0180-0182. The fix prevents future occurrences.

### Design

**WBS Numbering Fix (tasks.py ~line 679):**
```python
# BEFORE (buggy):
next_seq = len(existing_tasks) + 1

# AFTER (correct):
existing_wbs = [int(f.name[:4]) for f in prompt_dir.glob("[0-9][0-9][0-9][0-9]_*.md")]
next_seq = max(existing_wbs, default=0) + 1
```

**PreToolUse Hook (conceptual):**
```bash
# .claude/hooks/pretooluse-write-guard.sh
# Intercepts Write tool, checks if path matches docs/prompts/[0-9]{4}_*.md
# Returns {"decision": "block", "reason": "..."} if match
```

### Plan

1. **Fix WBS numbering in tasks.py**
   - [ ] Locate the `create` method in TasksManager
   - [ ] Replace `len(existing_tasks) + 1` with `max(WBS) + 1` logic
   - [ ] Add edge case handling for empty prompts directory
   - [ ] Add unit test for WBS numbering with gaps

2. **Create PreToolUse Write guard hook**
   - [ ] Create hook script or update existing `rd2_guard.sh`
   - [ ] Pattern match: `docs/prompts/[0-9]{4}_*.md`
   - [ ] Allow list: `.kanban.md`, `.template.md`, subdirectories
   - [ ] Add hook configuration to plugin settings

3. **Test and verify**
   - [ ] Run existing task CLI tests
   - [ ] Manually test: create task, delete it, create another (no collision)
   - [ ] Manually test: Write guard blocks direct file creation

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- Bug location: `plugins/rd2/skills/tasks/scripts/tasks.py` ~line 679
- Hook system docs: `rd2:cc-hooks` skill
- Existing guard: `.claude/hooks/rd2_guard.sh` (if exists)
- Analysis: super-brain and super-architect both flagged this independently

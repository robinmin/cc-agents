---
name: fix publish-to-x agent skill issue
description: Task: fix publish-to-x agent skill issue
status: Done
created_at: 2026-02-05 22:41:23
updated_at: 2026-02-05 23:30:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: pending
  testing: completed
---

## 0161. fix publish-to-x agent skill issue

### Background

For `plugins/wt/skills/publish-to-x/scripts/x-article-playwright.ts`, you need to fix the following issue:

### Cache login creadential

- Find out the the value of 'profile_dir' attribute from section "publish-to-x" in file plugin wt's config file `~/.claude/wt/config.jsonc`, say '~/.local/share/x-browser-profile'.

- On each launch time, you should automaticle re-use these cached login credential information to do autologin or something like that to ensre current login credential is still valid. In case of expiried or invalid, we will treat it as the new login. If success, we will auto maticly navigate to the destination web page. This case help to ask user login everytime, no matter for testing or real life. It's too bothering.

- In case of new user login. After a success login, we need to cache these login credential into the right place(which `profile_dir` point to);

### Enhance x-article-playwright.ts by x-article.ts

- Despite we can not make x-article.ts running smoothly on my environment, but it's good for others. So we need to learn so many places from it to make our x-article-playwright.ts stong enough to handle al kinds of scenarios.

- Meanwhile, we also need to add comprehensive unit tests for x-article-playwright.ts to make sure it's a robust and reliable tool for us.

### Token efficiency issue

- I alread noticed that when we use this tool to publish something to twitter, it's a token consuming proces so far. I guess that caused by the cover image? You need to find out the root cause and fix it if possible.

### Requirements

1. Cache login credentials using Playwright persistent context
2. Enhance x-article-playwright.ts with features from x-article.ts (I18N selectors, retry logic, multiple content insertion methods)
3. Fix token efficiency by not embedding HTML content in generated script
4. Add comprehensive unit tests

### Q&A

- Q: What causes the token efficiency issue?
- A: The original `generatePlaywrightScript` embedded the full HTML content via `JSON.stringify(htmlContent)` directly into the generated JavaScript string. For long articles, this made the script file enormous. Fixed by writing HTML to a temp file and having the script read it at runtime.

- Q: How does login caching work?
- A: Changed from `chromium.launch()` to `chromium.launchPersistentContext(profileDir, ...)`. This saves all browser state (cookies, localStorage, session data) to the profile directory. On subsequent runs, the browser session is restored automatically.

### Design

Key architectural changes:
1. **Persistent Context**: `chromium.launchPersistentContext(profileDir)` replaces `chromium.launch()` + manual 60s wait
2. **Login Detection**: `isLoggedIn(page)` checks URL patterns and DOM elements to determine auth state
3. **File-based HTML**: HTML written to temp file, script reads via `fs.readFileSync(HTML_FILE_PATH)` instead of embedding
4. **I18N Selectors**: Multi-language selector arrays (EN, CN, JP, KR) with `trySelectors()` helper
5. **Dual Content Insertion**: Paste event (primary) + `execCommand('insertHTML')` (fallback)

### Plan

1. Rewrite `x-article-playwright.ts` with persistent context, I18N selectors, token efficiency
2. Add `parseArgs()` as testable exported function
3. Export `I18N_SELECTORS` and `generatePlaywrightScript` for testing
4. Fix `md-to-html.ts` to add `import.meta.url` guard (needed for test imports)
5. Write 43 unit tests covering all exported functions
6. Verify all 55 tests pass (existing 12 + new 43)

### Artifacts

| Type | Path | Generated By | Date |
| ---- | ---- | ------------ | ---- |
| Source | plugins/wt/skills/publish-to-x/scripts/x-article-playwright.ts | super-coder | 2026-02-05 |
| Test | plugins/wt/skills/publish-to-x/tests/x-article-playwright.test.ts | super-coder | 2026-02-05 |
| Fix | plugins/wt/skills/publish-to-x/scripts/md-to-html.ts | super-coder | 2026-02-05 |

### References

- [Playwright Persistent Context API](https://playwright.dev/docs/api/class-browsertype#browser-type-launch-persistent-context)
- `plugins/wt/skills/publish-to-x/scripts/x-article.ts` - CDP-based implementation (source for I18N selectors, retry patterns)

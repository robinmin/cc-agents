---
name: add-structured-output-protocol-and-batch-create
description: "Phase 3: Add structured output protocol for agents and batch task creation from agent outputs"
status: Done
created_at: 2026-02-09 16:13:37
updated_at: 2026-02-10 09:03:13
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
dependencies: [0182]
tags: [tasks-enhancement, agent-protocol, pipeline]
---

## 0178. add-structured-output-protocol-and-batch-create

### Background

Currently, when agents like `rd2:super-brain` or `rd2:super-code-reviewer` complete their work, follow-up actions are often lost or manually tracked. There's no standardized way for agents to output structured task recommendations that automatically become task files.

The vision is task-file-centric workflow: every brainstorm, code review, and analysis activity should produce follow-up task files as first-class outputs. This ensures nothing falls through the cracks after intensive work sessions.

### Requirements

**Functional Requirements:**

1. **Structured output protocol for agents**:
   - Define a standard JSON footer format for agent outputs
   - Agents append `<!-- TASKS: [...] -->` to their output with structured task data
   - Each task entry includes: name, description, background, requirements, priority, dependencies
   - Protocol is optional — agents that don't produce tasks simply omit the footer

2. **Batch `tasks create` from agent output**:
   - `tasks batch-create <file>` — Parse structured output and create multiple task files
   - `tasks batch-create --from-agent-output <output-file>` — Extract tasks from agent output footer
   - Each created task gets proper WBS number, template, and content
   - Kanban board refreshed once after all tasks created

3. **Agent output protocol updates**:
   - Update agent skill documentation to describe the structured footer protocol
   - Add footer generation to key agents: super-brain, super-code-reviewer, super-architect
   - Footer is appended automatically, not replacing existing output format

4. **Pipeline integration**:
   - After agent completes, offer to create task files from structured output
   - `tasks from-brainstorm <brainstorm-output>` — Convenience wrapper
   - `tasks from-review <review-output>` — Convenience wrapper

**Acceptance Criteria:**
- [ ] Structured footer format defined and documented
- [ ] `tasks batch-create` creates multiple tasks from JSON input
- [ ] `tasks batch-create --from-agent-output` extracts and creates tasks from agent output
- [ ] At least one agent (super-brain) produces structured footer
- [ ] Kanban board synced after batch creation
- [ ] No task file is lost from agent recommendations

### Q&A

**Q:** What's the structured footer format?
**A:**
```html
<!-- TASKS:
[
  {
    "name": "implement-oauth-provider",
    "description": "Add OAuth2 provider support",
    "background": "Brainstorm identified OAuth as priority...",
    "requirements": "Support Google, GitHub providers...",
    "priority": "high",
    "depends_on": []
  }
]
-->
```

**Q:** Should the footer be in agent output files or in conversation?
**A:** In agent output files (follows path-based communication principle). Agents write to output files, pipeline tools read those files.

### Design

[Architecture/UI specs added by specialists]

### Plan

1. **Define structured output protocol**
   - [ ] Create protocol specification document
   - [ ] Define JSON schema for task entries
   - [ ] Define footer format (`<!-- TASKS: [...] -->`)
   - [ ] Document in a reference file under tasks skill

2. **Implement `tasks batch-create`**
   - [ ] Add `batch-create` subcommand to tasks CLI
   - [ ] Accept JSON file path or stdin
   - [ ] Parse and validate task entries
   - [ ] Create each task with proper WBS numbering
   - [ ] Single kanban refresh at end

3. **Implement agent output extraction**
   - [ ] Add `--from-agent-output` flag
   - [ ] Parse HTML comment footer from agent output files
   - [ ] Extract JSON task array
   - [ ] Feed to batch-create logic

4. **Update agent skills**
   - [ ] Add footer generation guidance to super-brain agent
   - [ ] Add footer generation guidance to super-code-reviewer agent
   - [ ] Add footer generation guidance to super-architect agent
   - [ ] Test with real agent runs

5. **Add convenience wrappers**
   - [ ] `tasks from-brainstorm` — extracts from brainstorm output format
   - [ ] `tasks from-review` — extracts from code review output format

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- Agent output protocol: path-based communication principle (CLAUDE.md)
- Related: 0182 (notification layer must be simplified first)
- super-brain agent: `plugins/rd2/agents/super-brain.md`
- super-code-reviewer agent: `plugins/rd2/agents/super-code-reviewer.md`

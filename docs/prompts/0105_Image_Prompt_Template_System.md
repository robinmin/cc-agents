---
name: Image Prompt Template System
description: Task: Image Prompt Template System
status: Done
created_at: 2026-01-29 20:42:50
updated_at: 2026-01-29 23:45:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
---

## 0105. Image Prompt Template System

### Background

The current `wt:image-generate` skill uses pre-defined styles and resolutions hardcoded in the skill. This creates two problems:

1. **Inconsistency**: Each image generation requires manually specifying the same parameters (style, resolution, backend) for similar use cases
2. **Poor Reusability**: No way to define a standard template once and reuse it across projects

We need a **declarative template system** that:
- Stores image generation specifications in reusable template files
- Supports variable substitution for dynamic content
- Allows project-specific overrides while maintaining sensible defaults
- Separates configuration (frontmatter) from content (prompt body)

**Key Design Decisions:**
- Template files use markdown with YAML frontmatter
- Variable syntax: `{{variable}}` with defaults `{{variable | default}}`
- Template storage: `plugins/wt/skills/image-generate/assets/` (defaults), `.image-templates/` (project overrides)
- Variable resolution: Merge/extend behavior (project overrides skill defaults)
- Style + Keywords: Intelligent merging (keywords enhance style presets)
- Error handling: Fail fast with clear error messages

### Requirements

#### Core Functionality

1. **Template File Structure**
   - File extension: `.tpl.md`
   - YAML frontmatter contains all image specifications
   - Markdown body contains the prompt template
   - Required frontmatter fields: `name`, `description`, `width`, `height`, `style`
   - Optional frontmatter fields: `backend`, `model`, `steps`, `output_filename`, `variables`, `keywords`

2. **Variable System**
   - Syntax: `{{variable_name}}` for required variables
   - Default values: `{{variable_name | default_value}}`
   - All values treated as strings (no type enforcement)
   - Missing variables without defaults: Leave as-is in output (literal `{{missing_var}}`)
   - Variables work in both frontmatter and body

3. **Template Resolution Order**
   1. Check project `.image-templates/` directory
   2. Fall back to `plugins/wt/skills/image-generate/assets/`
   3. Error if template not found

4. **CLI Integration**
   - New flag: `--template <name_or_path>` for template selection
   - New flag: `--var <key=value>` for variable assignment
   - Multiple variables: `--var title="X" --var author="Y"`
   - Optional `output_filename` in template, overridable by `--output`

5. **Style and Keywords**
   - `style`: Predefined preset (vibrant, technical-diagram, etc.)
   - `keywords`: Array of modifiers to override/enhance style
   - Intelligent merging: Quality keywords override quality, style keywords override style
   - Keywords automatically appended to prompt during generation

#### Template File Format

```yaml
---
name: cover
description: Article cover image template
width: 1920
height: 817
style: vibrant
backend: huggingface
steps: 50
output_filename: "{{title | cover}}.png"
variables:
  title:
    description: Article title
    default: "Article"
  subtitle:
    description: Article subtitle
    default: ""
  topics:
    description: Main topics
    default: "technology"
keywords: ["8K", "high-quality"]
---

Professional cover image for "{{title}}"{{subtitle | - {{subtitle}}}}.
{{topics | Modern, clean, tech-focused design}} showcasing the main theme.
```

#### Pre-defined Templates

Create three default templates in `assets/`:

1. **default.tpl.md**: General-purpose image generation
2. **cover.tpl.md**: Article covers (2.35:1 aspect ratio, vibrant style)
3. **illustrator.tpl.md**: Article illustrations (inline, technical-diagram style)

#### Error Handling

1. **Template not found**: Fail with clear error message listing available templates
2. **Invalid YAML**: Fail with parse error and line number
3. **Circular references**: Detect and report cycle
4. **Missing required fields**: Validate required frontmatter fields exist

#### Implementation Notes

- Store templates in: `plugins/wt/skills/image-generate/assets/templates/`
- Project override directory: `.image-templates/` (root level)
- Variable resolution: Project variables > Template defaults > Global defaults
- Backward compatibility: Existing `--style`, `--resolution` flags still work

### Q&A

[Clarifications added during planning phase]

### Design

[Architecture/UI specs added by specialists]

### Plan

[Step-by-step implementation plan]

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Template | `plugins/wt/skills/image-generate/assets/templates/default.tpl.md` | rd2:super-coder | |
| Template | `plugins/wt/skills/image-generate/assets/templates/cover.tpl.md` | rd2:super-coder | |
| Template | `plugins/wt/skills/image-generate/assets/templates/illustrator.tpl.md` | rd2:super-coder | |
| Code | `plugins/wt/skills/image-generate/scripts/template_engine.py` | rd2:super-coder | |
| Code | `plugins/wt/skills/image-generate/scripts/image_generator.py` (modified) | rd2:super-coder | |
| Tests | `plugins/wt/skills/image-generate/tests/test_template_engine.py` | rd2:super-coder | |
| Docs | `plugins/wt/skills/image-generate/SKILL.md` (updated) | rd2:super-coder | |

### References

- Current `wt:image-generate` skill: `plugins/wt/skills/image-generate/SKILL.md`
- Task 0102: Create wt:image-generate skill
- Task 0103: Create wt:image-cover skill
- Task 0104: Create wt:image-illustrator skill
